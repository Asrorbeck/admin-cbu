<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7 Qavatli Bino Planirovkasi - 3D Vizualizatsiya</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; }
        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            font-family: sans-serif;
            pointer-events: none; /* UI orqasidagi 3Dni bosishga xalaqit bermaslik uchun */
        }
        .btn {
            pointer-events: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .btn:hover { 
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        #info {
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid rgba(102, 126, 234, 0.3);
        }
        #personInfo {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.98);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
            border: 2px solid rgba(102, 126, 234, 0.4);
            min-width: 280px;
            max-width: 350px;
            display: none;
            pointer-events: auto;
            font-family: sans-serif;
        }
        #personInfo h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        #personInfo .info-row {
            margin: 12px 0;
            display: flex;
            justify-content: space-between;
        }
        #personInfo .info-label {
            font-weight: 600;
            color: #555;
        }
        #personInfo .info-value {
            color: #333;
            text-align: right;
        }
        #closeInfo {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        #closeInfo:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="ui-container">
        <div id="info">Qavatni tanlash uchun ustiga bosing</div>
        <button id="resetBtn" class="btn">Ortga (Binoni to'liq ko'rish)</button>
    </div>

    <div id="personInfo">
        <button id="closeInfo">Ã—</button>
        <h3 id="personName">Ism Familiya</h3>
        <div class="info-row">
            <span class="info-label">Lavozim:</span>
            <span class="info-value" id="personPosition">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Bo'lim:</span>
            <span class="info-value" id="personDepartment">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Telefon:</span>
            <span class="info-value" id="personPhone">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Xona:</span>
            <span class="info-value" id="personRoom">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Email:</span>
            <span class="info-value" id="personEmail">-</span>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 1. SAHNA SOZLAMALARI
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe0e0e0);
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(60, 50, 60); // Kattaroq bino uchun uzoqroqdan qarash

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Yorug'lik - yaxshilangan
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        
        // Asosiy yorug'lik
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
        dirLight.position.set(40, 80, 40);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        dirLight.shadow.camera.left = -100;
        dirLight.shadow.camera.right = 100;
        dirLight.shadow.camera.top = 100;
        dirLight.shadow.camera.bottom = -100;
        scene.add(dirLight);
        
        // Qo'shimcha yorug'lik (binoni yaxshiroq ko'rinish uchun)
        const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight2.position.set(-30, 50, -30);
        scene.add(dirLight2);
        
        // Yumshoq yorug'lik
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.4);
        hemiLight.position.set(0, 50, 0);
        scene.add(hemiLight);

        // Zamin - kattaroq bino uchun kattalashtirildi
        const plane = new THREE.Mesh(
            new THREE.PlaneGeometry(400, 400),
            new THREE.MeshStandardMaterial({ color: 0xd5dbdb })
        );
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);

        // ==========================================
        // 2. BINO LOGIKASI
        // ==========================================

        const floors = []; // Barcha qavatlarni shu yerda saqlaymiz
        const floorHeight = 4;
        const buildingWidth = 50; // Kattalashtirildi (10 dan 50 ga)
        const buildingDepth = 30; // Kattalashtirildi (10 dan 30 ga)
        const wallThickness = 0.3;
        const courtyardSize = 8; // Hovli o'lchami

        // Devor yaratuvchi yordamchi funksiya
        function createBox(w, h, d, x, y, z, color, isTransparent = false) {
            const geometry = new THREE.BoxGeometry(w, h, d);
            const material = new THREE.MeshStandardMaterial({ 
                color: color,
                transparent: true,
                opacity: isTransparent ? 0.3 : 1
            });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x, y, z);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            return mesh;
        }

        // Odam yaratish funksiyasi (soddalashtirilgan silindr shaklida)
        function createPerson(x, y, z, personData) {
            const personGroup = new THREE.Group();
            
            // Bosh (sfera)
            const headGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.set(0, 1.5, 0);
            head.castShadow = true;
            personGroup.add(head);
            
            // Tana (silindr)
            const bodyGeometry = new THREE.CylinderGeometry(0.25, 0.25, 1, 16);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: personData.color || 0x3498db });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(0, 0.5, 0);
            body.castShadow = true;
            personGroup.add(body);
            
            // Qo'llar
            const armGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.6, 8);
            const armMaterial = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.4, 0.5, 0);
            leftArm.rotation.z = Math.PI / 6;
            leftArm.castShadow = true;
            personGroup.add(leftArm);
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.4, 0.5, 0);
            rightArm.rotation.z = -Math.PI / 6;
            rightArm.castShadow = true;
            personGroup.add(rightArm);
            
            // Oyoqlar
            const legGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.8, 8);
            const legMaterial = new THREE.MeshStandardMaterial({ color: 0x34495e });
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.15, -0.4, 0);
            leftLeg.castShadow = true;
            personGroup.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.15, -0.4, 0);
            rightLeg.castShadow = true;
            personGroup.add(rightLeg);
            
            personGroup.position.set(x, y, z);
            
            // Odam ma'lumotlarini saqlash
            personGroup.userData = {
                isPerson: true,
                personData: personData
            };
            
            return personGroup;
        }

        // Qavat yaratish funksiyasi
        function createFloor(levelIndex) {
            const floorGroup = new THREE.Group();
            const yPos = (levelIndex * floorHeight) + (floorHeight / 2);

            // --- TASHQI DEVORLAR (Shell) ---
            const outerColor = 0x95a5a6; // Yaxshiroq kulrang
            const sideW = (buildingWidth - courtyardSize) / 2;
            const sideD = (buildingDepth - courtyardSize) / 2;
            
            // Pol (Asos) - kattaroq
            const floorPlate = createBox(buildingWidth, 0.3, buildingDepth, 0, yPos - floorHeight/2 + 0.15, 0, 0x7f8c8d);
            floorGroup.add(floorPlate);

            // Tashqi devorlar - 4 ta qism (o'rtada hovli)
            // Chap qanot
            floorGroup.add(createBox(sideW, floorHeight, buildingDepth, -sideW/2 - courtyardSize/2, yPos, 0, outerColor));
            // O'ng qanot
            floorGroup.add(createBox(sideW, floorHeight, buildingDepth, sideW/2 + courtyardSize/2, yPos, 0, outerColor));
            // Orqa qism (o'rtadagi)
            floorGroup.add(createBox(courtyardSize, floorHeight, sideD, 0, yPos, -sideD/2 - courtyardSize/2, outerColor));
            // Old qism (o'rtadagi)
            floorGroup.add(createBox(courtyardSize, floorHeight, sideD, 0, yPos, sideD/2 + courtyardSize/2, outerColor));

            // --- ICHKI PLAN (INTERYER) ---
            const internalGroup = new THREE.Group();
            internalGroup.visible = false;
            
            const innerColor = 0x3498db; // Ko'k ichki devorlar
            const roomColors = [0xf39c12, 0xe74c3c, 0x2ecc71, 0x9b59b6, 0x1abc9c]; // Turli xonalar uchun ranglar

            // Chap qanot ichki xonalari (5 ta xona)
            const leftRooms = 5;
            const roomWidth = (sideW - 0.5) / leftRooms;
            for (let i = 0; i < leftRooms; i++) {
                const roomX = -sideW/2 - courtyardSize/2 + (i + 0.5) * roomWidth;
                // Xona devorlari
                if (i < leftRooms - 1) {
                    internalGroup.add(createBox(0.2, floorHeight * 0.85, buildingDepth * 0.9, roomX + roomWidth/2, yPos, 0, innerColor));
                }
                // Mebel (stol)
                const furnitureX = roomX;
                const furnitureZ = -buildingDepth * 0.2 + (i % 3) * 2;
                internalGroup.add(createBox(roomWidth * 0.6, 0.6, 1.5, furnitureX, yPos - 1.2, furnitureZ, roomColors[i % roomColors.length]));
            }

            // O'ng qanot ichki xonalari (5 ta xona)
            const rightRooms = 5;
            const rightRoomWidth = (sideW - 0.5) / rightRooms;
            for (let i = 0; i < rightRooms; i++) {
                const roomX = sideW/2 + courtyardSize/2 - (i + 0.5) * rightRoomWidth;
                // Xona devorlari
                if (i < rightRooms - 1) {
                    internalGroup.add(createBox(0.2, floorHeight * 0.85, buildingDepth * 0.9, roomX - rightRoomWidth/2, yPos, 0, innerColor));
                }
                // Mebel
                const furnitureX = roomX;
                const furnitureZ = buildingDepth * 0.2 - (i % 3) * 2;
                internalGroup.add(createBox(rightRoomWidth * 0.6, 0.6, 1.5, furnitureX, yPos - 1.2, furnitureZ, roomColors[(i + 2) % roomColors.length]));
            }

            // Orqa qism xonalari (3 ta xona)
            const backRooms = 3;
            const backRoomDepth = (sideD - 0.5) / backRooms;
            for (let i = 0; i < backRooms; i++) {
                const roomZ = -sideD/2 - courtyardSize/2 + (i + 0.5) * backRoomDepth;
                // Xona devorlari
                if (i < backRooms - 1) {
                    internalGroup.add(createBox(courtyardSize * 0.9, floorHeight * 0.85, 0.2, 0, yPos, roomZ + backRoomDepth/2, innerColor));
                }
                // Mebel
                const furnitureX = -courtyardSize * 0.2 + (i % 2) * 2;
                internalGroup.add(createBox(1.5, 0.6, backRoomDepth * 0.6, furnitureX, yPos - 1.2, roomZ, roomColors[(i + 4) % roomColors.length]));
            }

            // Old qism xonalari (3 ta xona)
            const frontRooms = 3;
            const frontRoomDepth = (sideD - 0.5) / frontRooms;
            for (let i = 0; i < frontRooms; i++) {
                const roomZ = sideD/2 + courtyardSize/2 - (i + 0.5) * frontRoomDepth;
                // Xona devorlari
                if (i < frontRooms - 1) {
                    internalGroup.add(createBox(courtyardSize * 0.9, floorHeight * 0.85, 0.2, 0, yPos, roomZ - frontRoomDepth/2, innerColor));
                }
                // Mebel
                const furnitureX = courtyardSize * 0.2 - (i % 2) * 2;
                internalGroup.add(createBox(1.5, 0.6, frontRoomDepth * 0.6, furnitureX, yPos - 1.2, roomZ, roomColors[i % roomColors.length]));
            }

            floorGroup.add(internalGroup);

            // Qavatga ma'lumot biriktiramiz
            floorGroup.userData = {
                id: levelIndex,
                originalY: yPos,
                internalGroup: internalGroup,
                meshes: floorGroup.children.filter(c => c !== internalGroup)
            };

            return floorGroup;
        }

        // Birinchi qavatga odam qo'shish
        function addPersonToFloor(floorIndex, x, z, personData) {
            if (floors[floorIndex]) {
                const floor = floors[floorIndex];
                const yPos = (floorIndex * floorHeight) + 0.5; // Pol ustida
                const person = createPerson(x, yPos, z, personData);
                floor.userData.internalGroup.add(person);
            }
        }

        // 7 ta qavatni yaratamiz (ko'proq qavatlar)
        for (let i = 0; i < 7; i++) {
            const floor = createFloor(i);
            scene.add(floor);
            floors.push(floor);
        }

        // Birinchi qavatga odamlar qo'shamiz
        addPersonToFloor(0, -15, 5, {
            name: "Asrorbek Tursunpolatov",
            position: "Direktor",
            department: "Boshqarma",
            phone: "+998 90 123 45 67",
            room: "101",
            email: "asrorbek@example.com",
            color: 0x3498db
        });
        
        addPersonToFloor(0, -10, -8, {
            name: "Malika Karimova",
            position: "Bosh buxgalter",
            department: "Moliya bo'limi",
            phone: "+998 90 234 56 78",
            room: "102",
            email: "malika@example.com",
            color: 0xe74c3c
        });
        
        addPersonToFloor(0, 12, 3, {
            name: "Javohir Ismoilov",
            position: "IT menejeri",
            department: "Axborot texnologiyalari",
            phone: "+998 90 345 67 89",
            room: "103",
            email: "javohir@example.com",
            color: 0x2ecc71
        });
        
        addPersonToFloor(0, 8, -5, {
            name: "Dilshoda Rahimova",
            position: "Kadrlar bo'limi mudiri",
            department: "Kadrlar bo'limi",
            phone: "+998 90 456 78 90",
            room: "104",
            email: "dilshoda@example.com",
            color: 0x9b59b6
        });

        // ==========================================
        // 3. INTERAKTIVLIK (CLICK)
        // ==========================================
        
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let selectedFloorIndex = -1; // Hozircha hech narsa tanlanmagan
        
        const resetBtn = document.getElementById('resetBtn');
        const infoText = document.getElementById('info');
        const personInfoPanel = document.getElementById('personInfo');
        const closeInfoBtn = document.getElementById('closeInfo');

        // Odam ma'lumotlarini ko'rsatish
        function showPersonInfo(personData) {
            document.getElementById('personName').textContent = personData.name;
            document.getElementById('personPosition').textContent = personData.position;
            document.getElementById('personDepartment').textContent = personData.department;
            document.getElementById('personPhone').textContent = personData.phone;
            document.getElementById('personRoom').textContent = personData.room;
            document.getElementById('personEmail').textContent = personData.email;
            personInfoPanel.style.display = 'block';
        }

        // Ma'lumotlar panelini yopish
        closeInfoBtn.addEventListener('click', () => {
            personInfoPanel.style.display = 'none';
        });

        function onMouseClick(event) {
            // Agar "Reset" tugmasi yoki ma'lumotlar paneli yopish tugmasi bosilsa
            if(event.target.id === 'resetBtn' || event.target.id === 'closeInfo') return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            
            // Faqat ko'rinib turgan obyektlarni tekshiramiz
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                let clickedObject = intersects[0].object;
                
                // Avval odamga bosilganini tekshiramiz
                let checkObject = clickedObject;
                while(checkObject) {
                    if (checkObject.userData && checkObject.userData.isPerson) {
                        // Odamga bosildi - ma'lumotlarni ko'rsatamiz
                        showPersonInfo(checkObject.userData.personData);
                        return;
                    }
                    checkObject = checkObject.parent;
                }
                
                // Agar qavat tanlangangan bo'lsa, boshqa qavatlarni bosib bo'lmaydi
                if (selectedFloorIndex !== -1) {
                    return; // Qavat tanlanganda boshqa qavatlarni bosib bo'lmaydi
                }
                
                // Qavatni topish
                let object = clickedObject;
                while(object.parent && object.parent.type !== 'Scene') {
                    object = object.parent;
                }

                // Agar bu bizning qavatimiz bo'lsa
                if (object.userData && object.userData.id !== undefined) {
                    selectFloor(object.userData.id);
                }
            }
        }

        // Kamerani animatsiya bilan harakatlantirish
        function animateCamera(targetX, targetY, targetZ, duration = 1000) {
            const startX = camera.position.x;
            const startY = camera.position.y;
            const startZ = camera.position.z;
            const startTime = Date.now();

            function update() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing funksiyasi (yumshoq o'tish)
                const ease = 1 - Math.pow(1 - progress, 3);
                
                camera.position.x = startX + (targetX - startX) * ease;
                camera.position.y = startY + (targetY - startY) * ease;
                camera.position.z = startZ + (targetZ - startZ) * ease;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            update();
        }

        function selectFloor(index) {
            selectedFloorIndex = index;
            resetBtn.style.display = 'block';
            infoText.innerText = (index + 1) + "-qavat planirovkasi";

            floors.forEach((floor, i) => {
                const data = floor.userData;

                if (i === index) {
                    // TANLANGAN QAVAT:
                    floor.visible = true;
                    // Ichki xonalarni ko'rsatamiz
                    data.internalGroup.visible = true;
                    // Tashqi devorlarni biroz shaffof qilamiz (ichini yaxshi ko'rish uchun)
                    setOpacity(floor, 0.25); 
                } 
                else if (i > index) {
                    // TEPADAGI QAVATLAR:
                    // Ularni butunlay yashiramiz
                    floor.visible = false;
                } 
                else {
                    // PASTDAGI QAVATLAR:
                    // Ko'rinib tursin, lekin shaffof bo'lsin (orientir uchun)
                    floor.visible = true;
                    data.internalGroup.visible = false;
                    setOpacity(floor, 0.35); // Shaffof
                }
            });
            
            // Kamerani tanlangan qavatga yumshoq harakatlantirish
            const targetY = (index * floorHeight) + 20;
            const targetX = 70;
            const targetZ = 70;
            animateCamera(targetX, targetY, targetZ);
        }

        function resetView() {
            selectedFloorIndex = -1;
            resetBtn.style.display = 'none';
            infoText.innerText = "Qavatni tanlash uchun ustiga bosing";
            personInfoPanel.style.display = 'none'; // Ma'lumotlar panelini yopish

            floors.forEach(floor => {
                floor.visible = true;
                floor.userData.internalGroup.visible = false; // Ichki xonalarni yopish
                setOpacity(floor, 1); // Hammasini xira emas (opaque) qilish
            });
            
            // Kamerani boshlang'ich holatga qaytarish (animatsiya bilan)
            animateCamera(60, 50, 60);
        }

        // Shaffoflikni o'zgartiruvchi funksiya
        function setOpacity(group, opacity) {
            group.traverse((child) => {
                if (child.isMesh) {
                    child.material.transparent = opacity < 1;
                    child.material.opacity = opacity;
                }
            });
        }

        resetBtn.addEventListener('click', resetView);
        window.addEventListener('click', onMouseClick);
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

    </script>
</body>
</html>